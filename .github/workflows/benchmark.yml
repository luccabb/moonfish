name: Stockfish Benchmark

on:
  pull_request:
    branches: [ master ]

permissions:
  contents: read
  pull-requests: write

env:
  GIT_LFS_SKIP_SMUDGE: 1
  MOONFISH_OPENING_BOOK: ${{ github.workspace }}/opening_book/cerebellum.bin

jobs:
  benchmark:
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        chunk: [0, 1, 2, 3, 4, 5, 6, 7, 8, 9]  # 10 parallel jobs, 10 rounds each = 100 total per skill level
        skill_level: [4, 5]  # Test against both skill levels
    env:
      UV_SYSTEM_PYTHON: 1

    steps:
    - uses: actions/checkout@v4
      with:
        lfs: false
        fetch-depth: 0

    - name: Ensure opening book
      run: |
        set -euo pipefail

        if [ -f opening_book/cerebellum.bin ]; then
          if head -1 opening_book/cerebellum.bin | grep -q "git-lfs"; then
            echo "LFS pointer detected; downloading opening book..."
            rm -f opening_book/cerebellum.bin
          else
            echo "Opening book already present."
            exit 0
          fi
        fi

        echo "Downloading full opening book from release..."
        curl -L -o opening_book/cerebellum.bin "https://github.com/luccabb/moonfish/releases/download/v1.0.0/cerebellum.bin"

    - name: Verify opening book
      run: |
        ls -lh opening_book/cerebellum.bin
        python - <<'PY'
        import os, sys
        path = "opening_book/cerebellum.bin"
        size = os.path.getsize(path)
        print(f"opening book size: {size} bytes")
        if size < 10_000_000:
            print("opening book too small; likely an LFS pointer", file=sys.stderr)
            sys.exit(1)
        PY

    - name: Install uv
      uses: astral-sh/setup-uv@v5
      with:
        enable-cache: true
        cache-dependency-glob: "requirements.txt"

    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.10'

    - name: Install dependencies
      run: make install

    - name: Validate opening book with python-chess
      run: |
        python - <<'PY'
        import chess
        import chess.polyglot
        book_path = "opening_book/cerebellum.bin"
        with chess.polyglot.MemoryMappedReader(book_path) as reader:
            entry = reader.find(chess.Board())
        print(f"book entry: {entry.move.uci()}")
        PY

    - name: Install Stockfish
      run: |
        sudo apt-get update
        sudo apt-get install -y stockfish

    - name: Install cutechess-cli dependencies
      run: |
        sudo apt-get install -y cmake qt5-qmake qtbase5-dev qtbase5-dev-tools libqt5svg5-dev

    - name: Cache cutechess-cli
      id: cache-cutechess
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/cutechess-cli
        key: cutechess-cli-1.4.0

    - name: Build cutechess-cli
      if: steps.cache-cutechess.outputs.cache-hit != 'true'
      run: |
        git clone --depth 1 --branch v1.4.0 https://github.com/cutechess/cutechess.git /tmp/cutechess
        cd /tmp/cutechess
        mkdir build && cd build
        cmake ..
        make -j$(nproc)
        sudo cp cutechess-cli /usr/local/bin/

    - name: Build moonfish binary
      run: make build-lichess

    - name: Run Stockfish benchmark
      run: |
        CHUNK=${{ matrix.chunk }}
        SKILL=${{ matrix.skill_level }}
        ROUNDS_PER_CHUNK=10
        SEED=$((CHUNK * 1000 + SKILL * 100 + 42))  # Different seed per chunk/skill for opening variety

        echo "Running moonfish vs Stockfish benchmark (chunk $CHUNK, skill $SKILL)..."
        echo "Stockfish skill level: $SKILL"
        echo "Moonfish: 60s per move, Stockfish: 60+5 time control"
        echo "Rounds: $ROUNDS_PER_CHUNK, Concurrency: $(nproc), Seed: $SEED"
        echo ""

        cutechess-cli \
          -engine name=moonfish cmd=./dist/moonfish dir=. proto=uci tc=inf st=60 timemargin=10000 \
          -engine name=stockfish cmd=stockfish proto=uci option.Skill\ Level=$SKILL option.Threads=1 tc=60+5 timemargin=10000 \
          -rounds $ROUNDS_PER_CHUNK \
          -concurrency $(nproc) \
          -pgnout benchmark-skill$SKILL-chunk$CHUNK.pgn \
          -srand $SEED \
          -recover \
          2>&1 | tee benchmark-skill$SKILL-chunk$CHUNK.log

        echo ""
        echo "=== Benchmark Results (Skill $SKILL, Chunk $CHUNK) ==="
        tail -20 benchmark-skill$SKILL-chunk$CHUNK.log

    - name: Parse results
      run: |
        CHUNK=${{ matrix.chunk }}
        SKILL=${{ matrix.skill_level }}
        # Extract score line
        SCORE=$(grep "Score of moonfish vs stockfish:" benchmark-skill$SKILL-chunk$CHUNK.log | tail -1)

        # Parse wins/losses/draws
        WINS=$(echo "$SCORE" | sed -E 's/.*: ([0-9]+) - ([0-9]+) - ([0-9]+).*/\1/')
        LOSSES=$(echo "$SCORE" | sed -E 's/.*: ([0-9]+) - ([0-9]+) - ([0-9]+).*/\2/')
        DRAWS=$(echo "$SCORE" | sed -E 's/.*: ([0-9]+) - ([0-9]+) - ([0-9]+).*/\3/')

        # Save results to a simple file for aggregation (include skill level)
        echo "$SKILL $WINS $LOSSES $DRAWS" > results-skill$SKILL-chunk$CHUNK.txt

        echo "Skill $SKILL, Chunk $CHUNK: Wins=$WINS, Losses=$LOSSES, Draws=$DRAWS"

    - name: Upload chunk results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: benchmark-skill${{ matrix.skill_level }}-chunk${{ matrix.chunk }}
        path: |
          benchmark-skill${{ matrix.skill_level }}-chunk${{ matrix.chunk }}.pgn
          benchmark-skill${{ matrix.skill_level }}-chunk${{ matrix.chunk }}.log
          results-skill${{ matrix.skill_level }}-chunk${{ matrix.chunk }}.txt

  aggregate:
    runs-on: ubuntu-latest
    needs: benchmark
    if: always()
    steps:
    - uses: actions/checkout@v4

    - name: Download all chunk results
      uses: actions/download-artifact@v4
      with:
        pattern: benchmark-skill*-chunk*
        merge-multiple: true

    - name: Aggregate results
      run: |
        echo "Aggregating results from all chunks..."

        # Build comment body
        {
          echo "## ðŸ”¬ Stockfish Benchmark Results"
          echo ""
          echo "| Skill Level | Wins | Losses | Draws | Total | Win % | Loss % |"
          echo "|-------------|------|--------|-------|-------|-------|--------|"

          for SKILL in 4 5; do
            TOTAL_WINS=0
            TOTAL_LOSSES=0
            TOTAL_DRAWS=0

            for f in results-skill$SKILL-chunk*.txt; do
              if [ -f "$f" ]; then
                read FILE_SKILL WINS LOSSES DRAWS < "$f"
                echo "$(basename $f): W=$WINS L=$LOSSES D=$DRAWS" >&2
                TOTAL_WINS=$((TOTAL_WINS + WINS))
                TOTAL_LOSSES=$((TOTAL_LOSSES + LOSSES))
                TOTAL_DRAWS=$((TOTAL_DRAWS + DRAWS))
              fi
            done

            TOTAL=$((TOTAL_WINS + TOTAL_LOSSES + TOTAL_DRAWS))

            echo "" >&2
            echo "=== SKILL LEVEL $SKILL RESULTS ===" >&2
            echo "Total games: $TOTAL" >&2
            echo "Wins: $TOTAL_WINS | Losses: $TOTAL_LOSSES | Draws: $TOTAL_DRAWS" >&2

            if [ "$TOTAL" -gt 0 ]; then
              WIN_RATE=$(echo "scale=1; $TOTAL_WINS * 100 / $TOTAL" | bc)
              LOSS_RATE=$(echo "scale=1; $TOTAL_LOSSES * 100 / $TOTAL" | bc)
              echo "| $SKILL | $TOTAL_WINS | $TOTAL_LOSSES | $TOTAL_DRAWS | $TOTAL | ${WIN_RATE}% | ${LOSS_RATE}% |"
            else
              echo "| $SKILL | $TOTAL_WINS | $TOTAL_LOSSES | $TOTAL_DRAWS | $TOTAL | N/A | N/A |"
            fi
          done

          echo ""
          echo "<details><summary>Configuration</summary>"
          echo ""
          echo "- 10 parallel chunks Ã— 10 rounds Ã— 2 skill levels = 200 total games"
          echo "- Moonfish: 60s per move"
          echo "- Stockfish: 60+5 time control"
          echo ""
          echo "</details>"
        } > pr-comment.md

        # Also write to step summary
        cat pr-comment.md >> $GITHUB_STEP_SUMMARY

    - name: Comment on PR
      if: github.event_name == 'pull_request'
      env:
        GH_TOKEN: ${{ github.token }}
      run: |
        gh pr comment ${{ github.event.pull_request.number }} --body-file pr-comment.md

    - name: Merge all PGN files
      run: |
        for SKILL in 4 5; do
          cat benchmark-skill$SKILL-chunk*.pgn > benchmark-skill$SKILL-all.pgn 2>/dev/null || echo "No PGN files for skill $SKILL"
        done

    - name: Upload aggregated results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-aggregated
        path: |
          benchmark-skill*-all.pgn
          results-*.txt
